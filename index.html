<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<button id="toggle">Start</button>
<div id="text"></div>
<script>
    var recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = true;

    var isRecognizing = false;
    var phrases = [];

    recognition.onspeechstart = function () {
        phrases.push({
            text: "",
            timeStamp: Date.now(),
            isFinal: false
        });
    };

    recognition.onresult = function (e) {
        var phrase = e.results[0];
        var lastIndex = phrases.length - 1;
        phrases[lastIndex].text = phrase[0].transcript.trim();
        phrases[lastIndex].isFinal = phrase.isFinal;
        showPhrases(phrases);
    };

    recognition.onend = function () {
        if (isRecognizing) {
            recognition.start();
        }
    };

    document.getElementById("toggle").addEventListener("click", function () {
        if (isRecognizing) {
            recognition.abort();
        } else {
            recognition.start();
        }
        isRecognizing = !isRecognizing;
        document.getElementById("toggle").innerHTML = isRecognizing ? "Stop" : "Start";
    });

    function showPhrases(phrases) {
        var text = "";
        for (var i = phrases.length - 1; i >= 0; i--) {
            if (phrases[i].text === "") continue;
            var phrase = capitalize(phrases[i].text);
            if (phrases[i].isFinal || (i !== phrases.length - 1)) {
                phrase = addSentenceSymbol(phrase);
            }
            text += (new Date(phrases[i].timeStamp)).toLocaleTimeString() + ": " + phrase + "<br />";
        }
        document.getElementById("text").innerHTML = text;
    }

    function capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function addSentenceSymbol(sentence) {
        var lastSymbol = sentence[sentence.length - 1];
        if (lastSymbol === "." || lastSymbol === "!" || lastSymbol === "?") {
            return sentence;
        }
        if (isQuestionSentence(sentence)) {
            return sentence + "?";
        } else {
            return sentence + ".";
        }
    }

    function isQuestionSentence(sentence) {
        var affixes = ["Could",
            "Couldn’t",
            "Shall",
            "Should",
            "Shouldn’t",
            "Would",
            "Wouldn’t",
            "Will",
            "Won’t",
            "Do",
            "Did",
            "Didn’t",
            "Does",
            "Doesn’t",
            "Am",
            "Is",
            "Isn’t",
            "Are",
            "Aren’t",
            "Can",
            "Can’t",
            "Was",
            "Wasn’t",
            "Were",
            "Weren’t",
            "Has",
            "Hasn’t",
            "Have",
            "Haven’t",
            "Had",
            "Hadn’t",
            "Who",
            "What",
            "When",
            "Where",
            "How",
            "Why",
            "Which",
            "Might"];

        var words = sentence.split(/\s+/);
        var word0 = words.length > 0 ? words[0].trim().toUpperCase() : "";
        var word1 = words.length > 1 ? words[1].trim().toUpperCase() : "";

        for (var i = 0; i < affixes.length; i++) {
            var affix = affixes[i].toUpperCase();
            if (word0 === affix || word1 === affix) {
                return true;
            }
        }

        return false;
    }
</script>
</body>
</html>